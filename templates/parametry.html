<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Parametry gÅ‚osu</title>
</head>
<body>
    <h1>ğŸ¼ Analiza dÅºwiÄ™ku</h1>

    <!-- Dropdown z wyborem dÅºwiÄ™ku -->
    <label for="noteSelect">Wybierz dÅºwiÄ™k:</label>
    <select id="noteSelect">
        <option value="261.63">C</option>
        <option value="293.66">D</option>
        <option value="329.63">E</option>
        <option value="349.23">F</option>
        <option value="392.00">G</option>
        <option value="440.00">A</option>
        <option value="493.88">H</option>
    </select>

    <!-- Przycisk do odtwarzania dÅºwiÄ™ku -->
    <button onclick="playNote()">ğŸ”Š OdtwÃ³rz dÅºwiÄ™k</button>

    <!-- Przycisk do nagrywania -->
    <button onclick="startRecording()">ğŸ™ï¸ Nagraj dÅºwiÄ™k</button>
    <button onclick="stopRecording()">â¹ï¸ Stop</button>

    <!-- PodglÄ…d nagrania -->
    <audio id="recordedAudio" controls style="display:none;"></audio>

    <!-- Przycisk do wysÅ‚ania nagrania do serwera -->
    <form id="uploadForm" method="POST" enctype="multipart/form-data" action="/upload">
        <input type="file" id="audioFile" name="audio" hidden>
        <input type="hidden" id="targetFreqInput" name="target_freq">
        <button type="submit">ğŸ“¤ WyÅ›lij do analizy</button>
    </form>

    <!-- WyÅ›wietlanie wynikÃ³w analizy -->
    {% if analiza %}
        <h2>ğŸ“Š Wyniki analizy:</h2>
        <ul>
            {% for klucz, wartosc in analiza.items() %}
                <li><strong>{{ klucz }}:</strong> {{ wartosc }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <script>
        // 1. Odtwarzanie dÅºwiÄ™ku przez Web Audio API
        function playNote() {
            const freq = parseFloat(document.getElementById("noteSelect").value);
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
            oscillator.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 1.5); // odtwarzaj przez 1.5s
        }

        // 2. Nagrywanie dÅºwiÄ™ku przez mikrofon
        let mediaRecorder;
        let audioChunks = [];

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            audioChunks = [];

            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                const audioUrl = URL.createObjectURL(audioBlob);

                const audio = document.getElementById("recordedAudio");
                audio.src = audioUrl;
                audio.style.display = "block";

                // Wstawienie do inputa w formularzu
                const fileInput = document.getElementById("audioFile");
                const file = new File([audioBlob], "input.wav", { type: "audio/wav" });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;

                // Przekazanie wybranej czÄ™stotliwoÅ›ci
                document.getElementById("targetFreqInput").value = document.getElementById("noteSelect").value;
            });
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
        }
    </script>

    <br><br>
    <a href="{{ url_for('index') }}">â¬…ï¸ WrÃ³Ä‡ do nagrywania</a>
</body>
</html>
