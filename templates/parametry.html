<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>üéº Analiza ≈õpiewu - 7 parametr√≥w </title>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: radial-gradient(circle at top, #0a0a0a 0%, #000 80%);
            color: #f5f5f5;
            text-align: center;
            padding: 30px 10px;
        }

        h1, h2, h3 { color: #d4af37; }
        p { color: #dcdcdc; line-height: 1.6; }

        /* NAVBAR */
        .navbar {
            width: 100%;
            background: #000;
            border-bottom: 1px solid rgba(212,175,55,0.4);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.15);
        }

        .nav-container {
            width: 92%;
            margin: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-title { font-size: 1.3rem; font-weight: 600; color: #d4af37; }
        .nav-links a {
            color: #eee;
            text-decoration: none;
            margin: 0 12px;
            padding-bottom: 3px;
            transition: 0.25s;
        }
        .nav-links a:hover,
        .nav-links a.active {
            color: #f7d774;
            border-bottom: 2px solid #d4af37;
        }

        /* PRZYCISKI ‚Äì lepszy uk≈Çad ‚ú® */
        .button-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        button, .file-label {
            padding: 12px 26px;
            margin: 10px;
            font-size: 1rem;
            border: 1px solid #d4af37;
            background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
            color: #d4af37;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.25s;
            box-shadow: 0 0 8px rgba(212, 175, 55, 0.25);
        }

        button:hover,
        .file-label:hover {
            background: #222;
            color: #fff3b0;
            box-shadow: 0 0 14px rgba(212, 175, 55, 0.6);
            transform: scale(1.03);
        }

        input[type="file"] { display: none; }

        /* PARAMETRY */
        .param-container {
            margin: 40px auto;
            width: 90%;
            max-width: 1200px;
            background: #0d0d0d;
            border: 1px solid rgba(212,175,55,0.4);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 0 15px rgba(212,175,55,0.25);
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            justify-content: space-between;
        }

        .plot-box, .info-box { flex: 1 1 420px; }

        img.plot {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(212,175,55,0.3);
            border: 1px solid rgba(212,175,55,0.35);
        }

        /* HISTOGRAM */
        .chart-summary {
            width: 90%;
            max-width: 1200px;
            margin: 40px auto;
            background: #0d0d0d;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(212,175,55,0.4);
        }

        .overall { font-size: 1.7rem; color: #d4af37; margin-top: 25px; }

        audio { margin-top: 15px; width: 60%; }

        /* ‚ú® NOWY LOADING BAR */
        #loadingBox {
            display: none;
            margin: 25px auto;
            width: 60%;
            background: #111;
            border-radius: 10px;
            border: 1px solid rgba(212,175,55,0.5);
            padding: 15px;
            color: #f7d774;
        }

        #loadingProgress {
            height: 18px;
            background: #333;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }

        #loadingFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #d4af37, #f7d774);
        }

    </style>
</head>



<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-title">üéº Analiza ≈öpiewu - 7 parametr√≥w </div>
            <div class="nav-links">
                <a href="{{ url_for('index') }}">üè† Strona g≈Ç√≥wna</a>
                <a href="{{ url_for('parametry2') }}">üéµ Analiza 1 d≈∫wiƒôku</a>
                <a href="{{ url_for('parametry') }}" class="active">üìä Analiza parametr√≥w</a>
                <a href="{{ url_for('skala') }}">üéº Skala muzyczna</a>
            </div>
        </div>
    </nav>

    <h1>üé§ Analiza wykonania</h1>



    <!-- BUTTONS NOW IN A NICE ROW ‚ú® -->
    <div class="button-row">
        <button onclick="startRecording()">üéôÔ∏è Rozpocznij nagrywanie</button>
        <button onclick="stopRecording()">‚èπÔ∏è Zatrzymaj</button>

        <label for="manualUpload" class="file-label">üìÅ Wybierz plik</label>
        <input type="file" id="manualUpload" accept="audio/*" onchange="handleManualUpload(this)">
    </div>

    <audio id="recordedAudio" controls style="display:none;"></audio>

    <form method="POST" enctype="multipart/form-data" action="/analizuj_parametry" onsubmit="startLoading()">
        <input type="file" id="audioFile" name="audio" hidden>
        <button type="submit">üì§ Wy≈õlij nagranie do analizy</button>
    </form>


    <!-- ‚ú® NOWY LOADING BOX -->
    <div id="loadingBox">
        <h3>‚è≥ Trwa analiza nagrania‚Ä¶</h3>
        <div id="loadingProgress">
            <div id="loadingFill"></div>
        </div>
    </div>



{% if analiza %}

    <h2>üìä Wyniki analizy</h2>

    <!-- 1. INTONACJA -->
    <div class="param-container">
        <div class="plot-box">
            <h3>üéµ Intonation</h3>
            <img class="plot" src="{{ url_for('static', filename=wykres_intonation_path) }}">
        </div>
        <div class="info-box">
            <p>Por√≥wnanie konturu wysoko≈õci d≈∫wiƒôku. Im bardziej zbli≈ºone linie, tym lepsza intonacja.</p>
        </div>
    </div>

    <!-- 2. RYTM -->
    <div class="param-container">
        <div class="plot-box">
            <h3>‚è±Ô∏è Rhythm</h3>
            <img class="plot" src="{{ url_for('static', filename=wykres_rytm_path) }}">
        </div>
        <div class="info-box">
            <p>Analiza energii atak√≥w d≈∫wiƒôku. Zgodno≈õƒá kszta≈Çt√≥w oznacza dobre odwzorowanie rytmu.</p>
        </div>
    </div>

    <!-- 3. VIBRATO -->
    <div class="param-container">
        <div class="plot-box">
            <h3>üåä Vibrato</h3>
            <img class="plot" src="{{ url_for('static', filename=wykres_vibrato_path) }}">
        </div>
        <div class="info-box">
            <p>Regularne falowanie wskazuje zdrowe, naturalne vibrato.</p>
        </div>
    </div>

    <!-- 4. VOLUME -->
    <div class="param-container">
        <div class="plot-box">
            <h3>üîä Volume</h3>
            <img class="plot" src="{{ url_for('static', filename=wykres_volume_path) }}">
        </div>
        <div class="info-box">
            <p>Energia sygna≈Çu w czasie (RMS). Pokazuje dynamikƒô ≈õpiewu.</p>
        </div>
    </div>

    <!-- 5. VOICE QUALITY -->
    <div class="param-container">
        <div class="plot-box">
            <h3>üß¨ Voice Quality</h3>
            <img class="plot" src="{{ url_for('static', filename=wykres_vq_path) }}">
        </div>
        <div class="info-box">
            <p>Stosunek harmonicznych do szumu. Wy≈ºszy oznacza czystƒÖ barwƒô g≈Çosu.</p>
        </div>
    </div>

    <!-- 6. PRONUNCIATION -->
    <div class="param-container">
        <div class="plot-box">
            <h3>üó£Ô∏è Pronunciation</h3>
            <img class="plot" src="{{ url_for('static', filename=wykres_pron_path) }}">
        </div>
        <div class="info-box">
            <p>R√≥≈ºnice MFCC miƒôdzy wzorcem a nagraniem. Mniejsze oznaczajƒÖ wyra≈∫niejszƒÖ artykulacjƒô.</p>
        </div>
    </div>

    <!-- 7. PITCH RANGE -->
    <div class="param-container">
        <div class="plot-box">
            <h3>üîÅ Pitch Dynamic Range</h3>
            <img class="plot" src="{{ url_for('static', filename=wykres_range_path) }}">
        </div>
        <div class="info-box">
            <p>Zakres wykorzystywanej wysoko≈õci d≈∫wiƒôku. Wiƒôkszy = bardziej ekspresyjny ≈õpiew.</p>
        </div>
    </div>



    <!-- HISTOGRAM -->
    <div class="chart-summary">
        <h3>üìâ Histogram parametr√≥w</h3>
        <img class="plot" src="{{ url_for('static', filename=wykres_path) }}">
    </div>

    <p class="overall">‚≠ê Ocena og√≥lna: {{ analiza["‚≠ê Overall"] }}</p>

{% endif %}



<script>
    let mediaRecorder;
    let audioChunks = [];

    async function startRecording() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: "audio/wav" });
            const url = URL.createObjectURL(blob);

            const audio = document.getElementById("recordedAudio");
            audio.src = url;
            audio.style.display = "block";

            const file = new File([blob], "input.wav", { type: "audio/wav" });
            const dt = new DataTransfer();
            dt.items.add(file);
            document.getElementById("audioFile").files = dt.files;
        };

        mediaRecorder.start();
    }

    function stopRecording() {
        if (mediaRecorder) mediaRecorder.stop();
    }

    function handleManualUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const audio = document.getElementById("recordedAudio");
        audio.src = URL.createObjectURL(file);
        audio.style.display = "block";

        const dt = new DataTransfer();
        dt.items.add(file);
        document.getElementById("audioFile").files = dt.files;
    }

    /* ‚ú® NOWY LOADING ANIMATED PROGRESS BAR */
    function startLoading() {
        document.getElementById("loadingBox").style.display = "block";

        let fill = document.getElementById("loadingFill");
        let width = 0;

        let interval = setInterval(() => {
            width += 2;
            fill.style.width = width + "%";

            if (width >= 100) clearInterval(interval);
        }, 120);
    }
</script>

</body>
</html>
