<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>üéº Analiza ≈õpiewu ‚Äì Metoda ATSIP</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #fafafa;
            text-align: center;
            padding: 30px;
            color: #222;
        }
        h1 { color: #333; }
        button {
            margin: 10px;
            padding: 10px 20px;
            border: none;
            background: #4A90E2;
            color: white;
            font-size: 1rem;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover { background: #357ABD; }
        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 80%;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px 15px;
        }
        th {
            background: #4A90E2;
            color: white;
        }
        td:first-child { text-align: left; }
        .overall {
            font-size: 1.3rem;
            color: #2e7d32;
            font-weight: bold;
        }
        #chartContainer {
            margin: 40px auto;
            width: 90%;
            height: 400px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>üé§ Analiza por√≥wnawcza z nagraniem referencyjnym</h1>
    <p>Por√≥wnaj swoje nagranie z <strong>ref.wav.wav</strong> i sprawd≈∫ jako≈õƒá wykonania w 7 parametrach wg metody ATSIP (2018).</p>

    <button onclick="startRecording()">üéôÔ∏è Nagraj wykonanie</button>
    <button onclick="stopRecording()">‚èπÔ∏è Zatrzymaj</button>

    <audio id="recordedAudio" controls style="display:none; margin-top:20px;"></audio>

    <form id="uploadForm" method="POST" enctype="multipart/form-data" action="/analizuj_parametry" style="margin-top:20px;">
        <input type="file" id="audioFile" name="audio" hidden>
        <button type="submit">üì§ Wy≈õlij do analizy</button>
    </form>

    {% if analiza %}
        <h2>üìä Wyniki analizy (7 parametr√≥w):</h2>
        <table>
            <tr><th>Parametr</th><th>Wynik (%)</th></tr>
            {% for klucz, wartosc in analiza.items() %}
                {% if "Overall" not in klucz %}
                    <tr><td>{{ klucz }}</td><td>{{ wartosc }}</td></tr>
                {% endif %}
            {% endfor %}
        </table>

        <!-- bezpieczne przekazanie danych JSON -->
        <script id="analiza-data" type="application/json">
            {{ analiza | tojson }}
        </script>

        <div id="chartContainer">
            <canvas id="chart" width="700" height="300"></canvas>
        </div>

        <script>
            // Wczytanie danych z ukrytego skryptu JSON
            const dataAnalizy = JSON.parse(document.getElementById('analiza-data').textContent);

            const labels = [];
            const values = [];

            for (const [k, v] of Object.entries(dataAnalizy)) {
                if (k.includes("Overall")) continue;
                const num = parseFloat(String(v).replace("%", "").replace("/ 100", "").trim());
                if (!Number.isNaN(num)) {
                    labels.push(k);
                    values.push(num);
                }
            }

            // Tworzenie wykresu
            const ctx = document.getElementById("chart").getContext("2d");
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels,
                    datasets: [{
                        label: "Wynik (%)",
                        data: values,
                        backgroundColor: "#4A90E2"
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (ctx) => `${ctx.formattedValue} %` } }
                    }
                }
            });
        </script>

        <p class="overall">‚≠ê Ocena og√≥lna: {{ analiza["‚≠ê Overall"] }}</p>
    {% endif %}

    <script>
        let mediaRecorder;
        let audioChunks = [];

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.addEventListener("dataavailable", e => audioChunks.push(e.data));
            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                const audioUrl = URL.createObjectURL(audioBlob);

                const audio = document.getElementById("recordedAudio");
                audio.src = audioUrl;
                audio.style.display = "block";

                const file = new File([audioBlob], "input.wav", { type: "audio/wav" });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById("audioFile").files = dataTransfer.files;
            });

            mediaRecorder.start();
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
        }
    </script>

    <br><br>
    <a href="/">‚¨ÖÔ∏è Wr√≥ƒá</a>
</body>
</html>